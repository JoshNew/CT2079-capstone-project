<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Event Ease</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fc;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 0.9rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .page-title {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #666;
            font-size: 1rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: #666;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .badge {
            background: rgba(255, 255, 255, 0.3);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tab-btn.active .badge {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-btn:not(.active) .badge {
            background: #667eea;
            color: white;
        }

        .loading, .no-data, .error-message {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading {
            color: #667eea;
            font-size: 1.2rem;
        }

        .no-data {
            color: #666;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .bookings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .booking-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .booking-card.cancelled {
            opacity: 0.8;
        }

        .booking-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .booking-card.cancelled .booking-header {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .booking-id {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .event-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .booking-date {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .status-badge {
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-used {
            background: #e9ecef;
            color: #495057;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-passed {
            background: #fff3cd;
            color: #856404;
        }

        .booking-body {
            padding: 1.5rem;
        }

        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .detail-icon {
            font-size: 1.3rem;
            margin-top: 0.1rem;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
        }

        .detail-value {
            color: #333;
            font-weight: 500;
        }

        .seats-section {
            background: #f8f9fc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .seats-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .seats-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .seat-tag {
            background: white;
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
            border: 2px solid #667eea;
        }

        .price-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fc;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .price-label {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        .price-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .booking-actions {
            display: flex;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-view:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: #ef4444;
            color: white;
        }

        .btn-cancel:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-cancel:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .success-banner {
            background: #d4edda;
            color: #155724;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 1px solid #c3e6cb;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .success-banner.show {
            display: flex;
        }

        .close-banner {
            background: none;
            border: none;
            color: #155724;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .refund-notice {
            background: #fff3cd;
            color: #856404;
            padding: 0.75rem;
            border-radius: 5px;
            margin-top: 1rem;
            font-size: 0.9rem;
            border: 1px solid #ffeeba;
        }

        /* Cancel Booking Modal */
        .cancel-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .cancel-modal.active {
            display: flex;
        }

        .cancel-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .cancel-modal-header {
            padding: 2rem 2rem 1rem;
            text-align: center;
        }

        .cancel-icon {
            width: 80px;
            height: 80px;
            background: #fee2e2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            animation: iconPulse 2s infinite;
        }

        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .cancel-icon svg {
            width: 40px;
            height: 40px;
            color: #ef4444;
        }

        .cancel-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .cancel-modal-subtitle {
            font-size: 0.95rem;
            color: #6b7280;
        }

        .cancel-modal-body {
            padding: 1.5rem 2rem;
        }

        .booking-info-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .booking-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .booking-info-item:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .info-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .info-value {
            font-size: 0.95rem;
            color: #1f2937;
            font-weight: 600;
            text-align: right;
        }

        .refund-warning {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            gap: 0.75rem;
        }

        .refund-warning-icon {
            color: #3b82f6;
            flex-shrink: 0;
        }

        .refund-warning-text {
            color: #1e40af;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .refund-warning-text strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .cancel-modal-footer {
            padding: 0 2rem 2rem;
            display: flex;
            gap: 1rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-keep {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-keep:hover {
            background: #e5e7eb;
        }

        .btn-confirm-cancel {
            background: #ef4444;
            color: white;
        }

        .btn-confirm-cancel:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-confirm-cancel:active {
            transform: translateY(0);
        }

        /* Success Dialog */
        .success-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            text-align: center;
            min-width: 350px;
            animation: successSlideIn 0.3s ease-out;
        }

        .success-dialog.active {
            display: block;
        }

        @keyframes successSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .success-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2999;
        }

        .success-dialog-overlay.active {
            display: block;
        }

        .success-icon-circle {
            width: 80px;
            height: 80px;
            background: #d4edda;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            animation: successPulse 0.5s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-icon-circle svg {
            width: 45px;
            height: 45px;
            color: #28a745;
        }

        .success-dialog-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .success-dialog-message {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .success-dialog-btn {
            background: #28a745;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .success-dialog-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* E-Ticket Modal */
        .ticket-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .ticket-modal.active {
            display: flex;
        }

        .ticket-container {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .ticket-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }

        .ticket-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .ticket-title {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .ticket-event-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .ticket-body {
            padding: 2rem 2rem 1.5rem;
        }

        .ticket-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .ticket-info-item {
            text-align: center;
        }

        .ticket-info-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .ticket-info-value {
            font-size: 1rem;
            color: #333;
            font-weight: 600;
        }

        .ticket-seats-section {
            background: #f8f9fc;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .ticket-seats-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .ticket-seats-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        .ticket-seat-badge {
            background: #667eea;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .ticket-qr-section {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fc;
            border-radius: 10px;
        }

        .ticket-qr-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        #qrcode {
            display: inline-block;
            padding: 1rem;
            background: white;
            border-radius: 10px;
        }

        .ticket-qr-text {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: #999;
        }

        .ticket-footer {
            background: #f8f9fc;
            padding: 1.5rem 2rem;
            text-align: center;
            border-top: 2px dashed #e1e1e1;
        }

        .ticket-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .ticket-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ticket-btn-print {
            background: #667eea;
            color: white;
        }

        .ticket-btn-print:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .ticket-note {
            font-size: 0.85rem;
            color: #999;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .ticket-info-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .ticket-title {
                font-size: 1.5rem;
            }

            .ticket-event-name {
                font-size: 1.4rem;
            }

            .ticket-body {
                padding: 2rem 1.5rem 1.5rem;
            }

            .main-content {
                padding: 0 1rem;
            }

            .tabs {
                flex-direction: column;
                gap: 0.5rem;
            }

            .booking-header {
                flex-direction: column;
                gap: 1rem;
            }

            .booking-details {
                grid-template-columns: 1fr;
            }

            .booking-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<!-- QR Code Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<header class="header">
    <div class="header-content">
        <div class="logo">My Bookings</div>
        <a href="/customer-dashboard" class="back-btn">⬅ Back to Dashboard</a>
    </div>
</header>

<main class="main-content">
    <div class="page-header">
        <h1 class="page-title">My Bookings</h1>
        <p class="page-subtitle">View and manage all your event bookings</p>
    </div>

    <div id="successBanner" class="success-banner">
        <span id="successMessage"></span>
        <button class="close-banner" onclick="hideSuccessBanner()">X</button>
    </div>

    <div class="stats-row" id="statsRow">
        <div class="stat-box">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="confirmedCount">0</div>
            <div class="stat-label">Active Bookings</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="usedCount">0</div>
            <div class="stat-label">Used</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="cancelledCount">0</div>
            <div class="stat-label">Cancelled</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="passedCount">0</div>
            <div class="stat-label">Passed</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="totalSpent">$0</div>
            <div class="stat-label">Total Spent</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all')">
            All Bookings
            <span class="badge" id="allBadge">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('confirmed')">
            Active
            <span class="badge" id="confirmedBadge">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('used')">
            Used
            <span class="badge" id="usedBadge">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('cancelled')">
            Cancelled
            <span class="badge" id="cancelledBadge">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('passed')">
            Passed
            <span class="badge" id="passedBadge">0</span>
        </button>
    </div>

    <div id="loadingMessage" class="loading">
        Loading your bookings...
    </div>

    <div id="errorMessage" class="error-message" style="display: none;">
        <strong>Error:</strong> <span id="errorText">Unable to load bookings.</span>
        <br><br>
        <button class="btn btn-view" onclick="loadBookings()">Retry</button>
    </div>

    <div id="noDataMessage" class="no-data" style="display: none;">
        <div class="empty-icon">🎫</div>
        <h3>No bookings found</h3>
        <p style="margin-top: 0.5rem;">Start by browsing available events!</p>
        <button class="btn btn-view" onclick="browseEvents()" style="margin-top: 1rem; width: auto; padding: 0.75rem 1.5rem;">
            Browse Events
        </button>
    </div>

    <div id="bookingsGrid" class="bookings-grid" style="display: none;">
        <!-- Booking cards will be inserted here -->
    </div>
</main>

<!-- Cancel Booking Modal -->
<div id="cancelModal" class="cancel-modal">
    <div class="cancel-modal-content">
        <div class="cancel-modal-header">
            <div class="cancel-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="cancel-modal-title">Cancel Booking?</h2>
            <p class="cancel-modal-subtitle">This action cannot be undone</p>
        </div>

        <div class="cancel-modal-body">
            <div class="booking-info-box">
                <div class="booking-info-item">
                    <span class="info-label">Event Name</span>
                    <span class="info-value" id="modalEventName">-</span>
                </div>
                <div class="booking-info-item">
                    <span class="info-label">Booking ID</span>
                    <span class="info-value" id="modalBookingId">-</span>
                </div>
                <div class="booking-info-item">
                    <span class="info-label">Total Amount</span>
                    <span class="info-value" id="modalAmount">-</span>
                </div>
            </div>

            <div class="refund-warning">
                <div class="refund-warning-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                </div>
                <div class="refund-warning-text">
                    <strong>Refund Information</strong>
                    Your payment will be refunded to your original payment method within 5-7 business days.
                </div>
            </div>
        </div>

        <div class="cancel-modal-footer">
            <button class="modal-btn btn-keep" onclick="closeCancelModal()">
                Keep Booking
            </button>
            <button class="modal-btn btn-confirm-cancel" onclick="confirmCancelBooking()">
                Yes, Cancel Booking
            </button>
        </div>
    </div>
</div>

<!-- Success Dialog -->
<div class="success-dialog-overlay" id="successDialogOverlay"></div>
<div id="successDialog" class="success-dialog">
    <div class="success-icon-circle">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
    </div>
    <h2 class="success-dialog-title">Cancelled Successfully</h2>
    <p class="success-dialog-message">Your booking has been cancelled and refund has been processed.</p>
    <button class="success-dialog-btn" onclick="closeSuccessDialog()">OK</button>
</div>

<!-- E-Ticket Modal -->
<div id="ticketModal" class="ticket-modal">
    <div class="ticket-container">
        <button class="ticket-close" onclick="closeTicketModal()">X</button>

        <div class="ticket-header">
            <div class="ticket-title">E-TICKET</div>
            <div class="ticket-event-name" id="ticketEventName">Event Name</div>
        </div>

        <div class="ticket-body">
            <div class="ticket-info-grid">
                <div class="ticket-info-item">
                    <div class="ticket-info-label">Ticket Holder</div>
                    <div class="ticket-info-value" id="ticketHolder">John Doe</div>
                </div>
                <div class="ticket-info-item">
                    <div class="ticket-info-label">Booking ID</div>
                    <div class="ticket-info-value" id="ticketBookingId">ABC123</div>
                </div>
                <div class="ticket-info-item">
                    <div class="ticket-info-label">Date & Time</div>
                    <div class="ticket-info-value" id="ticketDateTime">TBA</div>
                </div>
                <div class="ticket-info-item">
                    <div class="ticket-info-label">Venue</div>
                    <div class="ticket-info-value" id="ticketVenue">TBA</div>
                </div>
                <div class="ticket-info-item">
                    <div class="ticket-info-label">Category</div>
                    <div class="ticket-info-value" id="ticketCategory">Event</div>
                </div>
                <div class="ticket-info-item">
                    <div class="ticket-info-label">Total Tickets</div>
                    <div class="ticket-info-value" id="ticketCount">1</div>
                </div>
            </div>

            <div class="ticket-seats-section">
                <div class="ticket-seats-title">Your Seats</div>
                <div class="ticket-seats-list" id="ticketSeatsList">
                    <!-- Seats will be populated here -->
                </div>
            </div>

            <div class="ticket-qr-section">
                <div class="ticket-qr-title">Scan to Verify</div>
                <div id="qrcode"></div>
                <div class="ticket-qr-text" id="qrcodeText">Booking ID</div>
            </div>
        </div>

        <div class="ticket-footer">
            <div class="ticket-actions">
                <button class="ticket-btn ticket-btn-print" onclick="printTicket()">
                    🖨️ Print Ticket
                </button>
            </div>
            <div class="ticket-note">
                Please present this ticket at the venue entrance.<br>
                Scan the QR code for verification.<br>
                For support, contact us at support@eventease.com
            </div>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let allBookings = [];
    let eventsCache = {};
    let currentTab = 'all';
    let currentBookingId = null;
    let currentEventName = null;
    let currentBookingAmount = null;

    window.addEventListener('load', function() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const userData = sessionStorage.getItem('user');

        if (!isLoggedIn || !userData) {
            window.location.href = '/login';
            return;
        }

        currentUser = JSON.parse(userData);
        loadBookings();
    });

    async function loadBookings() {
        try {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('bookingsGrid').style.display = 'none';

            const userId = getUserId(currentUser);
            const response = await fetch(`/api/bookings/user/${userId}`);

            if (!response.ok) {
                throw new Error('Failed to fetch bookings');
            }

            allBookings = await response.json();

            // Sort by booking date (newest first)
            allBookings.sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));

            // Fetch organizer data for all events
            const uniqueEventIds = [...new Set(allBookings.map(b => b.eventId))];
            await Promise.all(uniqueEventIds.map(id => fetchEventData(id)));

            // Check and update passed bookings
            await checkAndUpdatePassedBookings();

            updateStats();
            displayBookings();

        } catch (error) {
            console.error('Error loading bookings:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = error.message;
        }
    }

    async function fetchEventData(eventId) {
        if (eventsCache[eventId]) return;

        try {
            const response = await fetch(`/api/events/${eventId}`);
            if (response.ok) {
                const event = await response.json();
                eventsCache[eventId] = event;
            }
        } catch (error) {
            console.error('Error fetching event data:', error);
            eventsCache[eventId] = {
                name: 'Event Unavailable',
                location: 'N/A',
                eventDate: '',
                eventTime: ''
            };
        }
    }

    function updateStats() {
        const confirmed = allBookings.filter(b => b.status === 'confirmed');
        const used = allBookings.filter(b => b.status === 'used');
        const cancelled = allBookings.filter(b => b.status === 'cancelled');
        const passed = allBookings.filter(b => b.status === 'passed');
        const totalSpent = [...confirmed, ...used, ...passed].reduce((sum, b) => sum + b.totalPrice, 0);

        document.getElementById('totalCount').textContent = allBookings.length;
        document.getElementById('confirmedCount').textContent = confirmed.length;
        document.getElementById('usedCount').textContent = used.length;
        document.getElementById('cancelledCount').textContent = cancelled.length;
        document.getElementById('passedCount').textContent = passed.length;
        document.getElementById('totalSpent').textContent = `$${totalSpent.toFixed(2)}`;

        document.getElementById('allBadge').textContent = allBookings.length;
        document.getElementById('confirmedBadge').textContent = confirmed.length;
        document.getElementById('usedBadge').textContent = used.length;
        document.getElementById('cancelledBadge').textContent = cancelled.length;
        document.getElementById('passedBadge').textContent = passed.length;
    }

    function displayBookings() {
        document.getElementById('loadingMessage').style.display = 'none';

        let filteredBookings = allBookings;

        if (currentTab === 'confirmed') {
            filteredBookings = allBookings.filter(b => b.status === 'confirmed');
        } else if (currentTab === 'used') {
            filteredBookings = allBookings.filter(b => b.status === 'used');
        } else if (currentTab === 'cancelled') {
            filteredBookings = allBookings.filter(b => b.status === 'cancelled');
        } else if (currentTab === 'passed') {
            filteredBookings = allBookings.filter(b => b.status === 'passed');
        }

        if (filteredBookings.length === 0) {
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('bookingsGrid').style.display = 'none';
            return;
        }

        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('bookingsGrid').style.display = 'grid';

        const bookingsGrid = document.getElementById('bookingsGrid');
        bookingsGrid.innerHTML = '';

        filteredBookings.forEach(booking => {
            const card = createBookingCard(booking);
            bookingsGrid.appendChild(card);
        });
    }

    function createBookingCard(booking) {
        const card = document.createElement('div');
        card.className = `booking-card ${(booking.status === 'cancelled' || booking.status === 'used' || booking.status === 'passed') ?
            'cancelled' : ''}`;
        const event = eventsCache[booking.eventId] || {};
        const bookingDate = new Date(booking.bookingDate);
        const formattedBookingDate = bookingDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const eventDateTime = formatEventDateTime(event.eventDate, event.eventTime);

        let statusClass = 'status-confirmed';
        let statusText = 'Confirmed';

        if (booking.status === 'used') {
            statusClass = 'status-used';
            statusText = 'Used';
        } else if (booking.status === 'cancelled') {
            statusClass = 'status-cancelled';
            statusText = 'Cancelled';
        } else if (booking.status === 'passed') {
            statusClass = 'status-passed';
            statusText = 'Passed';
        }


        const eventHasPassed = isEventPast(event.eventDate, event.eventTime);
        let cancelButton = '';
        if (booking.status === 'confirmed' || booking.status === 'passed') {
            if (eventHasPassed) {
                // Event has passed - show disabled button with message
                cancelButton = `
                <button class="btn btn-cancel" disabled style="opacity: 0.5; cursor: not-allowed;"
                        title="Cannot cancel - event has already occurred">
                    Event Passed
                </button>`;
            } else {
                // Event is in the future - show regular cancel button
                cancelButton = `
                <button class="btn btn-cancel" onclick="showCancelModal('${booking.id}', '${event.name}', ${booking.totalPrice})">
                    Cancel Booking
                </button>`;
            }
        }

        let additionalNotice = '';
        if (booking.status === 'cancelled') {
            additionalNotice = '<div class="refund-notice">💰 Refund has been processed to your original payment method</div>';
        } else if (booking.status === 'used') {
            additionalNotice = '<div class="refund-notice" style="background: #d1ecf1; color: #0c5460; border-color: #bee5eb;">✅ Ticket has been used for entry</div>';
        } else if (booking.status === 'passed') {
            additionalNotice = '<div class="refund-notice" style="background: #fff3cd; color: #856404; border-color: #ffeaa7;">⏰ This event has already passed</div>';
        }

        const priceLabel = booking.status === 'cancelled' ? 'Total Amount (Refunded)' : 'Total Amount Paid';

        card.innerHTML = `
        <div class="booking-header">
            <div>
                <div class="booking-id">Booking ID: ${booking.id.substring(0, 12)}</div>
                <div class="event-name">${event.name || 'Event'}</div>
                <div class="booking-date">Booked on ${formattedBookingDate}</div>
            </div>
            <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        <div class="booking-body">
            <div class="booking-details">
                <div class="detail-item">
                    <div class="detail-icon">📍</div>
                    <div class="detail-content">
                        <div class="detail-label">Location</div>
                        <div class="detail-value">${event.location || 'TBA'}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">🗓️</div>
                    <div class="detail-content">
                        <div class="detail-label">Event Date & Time</div>
                        <div class="detail-value">${eventDateTime}</div>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-icon">🎫</div>
                    <div class="detail-content">
                        <div class="detail-label">Tickets</div>
                        <div class="detail-value">${booking.seats.length} ticket${booking.seats.length > 1 ? 's' : ''}</div>
                    </div>
                </div>
            </div>

            <div class="seats-section">
                <div class="seats-title">Your Seats</div>
                <div class="seats-list">
                    ${booking.seats.map(seat => `
                        <span class="seat-tag">${seat.seatType} - Seat ${seat.seatNumber}</span>
                    `).join('')}
                </div>
            </div>

            <div class="price-section">
                <div class="price-label">${priceLabel}</div>
                <div class="price-value">$${booking.totalPrice.toFixed(2)}</div>
            </div>

            <div class="payment-info">
                <span>💳</span>
                <span>${formatPaymentMethod(booking.paymentMethod)}</span>
            </div>

            ${additionalNotice}

            <div class="booking-actions">
                <button class="btn btn-view" onclick="viewTicket('${booking.id}')">
                    View E-Ticket
                </button>
                ${cancelButton}
            </div>
        </div>
    `;

        return card;
    }

    function formatEventDateTime(date, time) {
        if (!date) return 'Date TBA';

        const dateObj = new Date(date + 'T00:00:00');
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        const formattedDate = dateObj.toLocaleDateString('en-US', options);

        if (time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${formattedDate} at ${displayHour}:${minutes} ${ampm}`;
        }

        return formattedDate;
    }

    function formatPaymentMethod(method) {
        const methods = {
            'credit-card': 'Credit Card',
            'debit-card': 'Debit Card',
            'paypal': 'PayPal'
        };
        return methods[method] || method;
    }

    // Cancel Modal Functions
    function showCancelModal(bookingId, eventName, totalAmount) {
        currentBookingId = bookingId;
        currentEventName = eventName;
        currentBookingAmount = totalAmount;

        document.getElementById('modalEventName').textContent = eventName;
        document.getElementById('modalBookingId').textContent = bookingId.substring(0, 12).toUpperCase();
        document.getElementById('modalAmount').textContent = `$${totalAmount.toFixed(2)}`;

        document.getElementById('cancelModal').classList.add('active');
    }

    function closeCancelModal() {
        document.getElementById('cancelModal').classList.remove('active');
        currentBookingId = null;
        currentEventName = null;
        currentBookingAmount = null;
    }

    async function confirmCancelBooking() {
        if (!currentBookingId) return;

        // Save the values to local variables before closing modal
        const bookingId = currentBookingId;
        const eventName = currentEventName;

        closeCancelModal();
        await cancelBooking(bookingId, eventName);
    }

    async function cancelBooking(bookingId, eventName) {
        try {
            const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                method: 'PUT'
            });

            if (response.ok) {
                showSuccessDialog();
                await loadBookings();
            } else {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to cancel booking');
            }

        } catch (error) {
            console.error('Error cancelling booking:', error);
            alert('Failed to cancel booking: ' + error.message);
        }
    }

    function showSuccessDialog() {
        document.getElementById('successDialog').classList.add('active');
        document.getElementById('successDialogOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeSuccessDialog() {
        document.getElementById('successDialog').classList.remove('active');
        document.getElementById('successDialogOverlay').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function viewTicket(bookingId) {
        const booking = allBookings.find(b => b.id === bookingId);
        if (!booking) return;

        const event = eventsCache[booking.eventId] || {};

        // Populate ticket information
        document.getElementById('ticketEventName').textContent = event.name || 'Event';
        document.getElementById('ticketHolder').textContent = currentUser.name;
        document.getElementById('ticketBookingId').textContent = booking.id.substring(0, 12).toUpperCase();
        document.getElementById('ticketDateTime').textContent = formatEventDateTime(event.eventDate, event.eventTime);
        document.getElementById('ticketVenue').textContent = event.location || 'TBA';
        document.getElementById('ticketCategory').textContent = event.category || 'Event';
        document.getElementById('ticketCount').textContent = `${booking.seats.length} Ticket${booking.seats.length > 1 ? 's' : ''}`;

        // Populate seats
        const seatsList = document.getElementById('ticketSeatsList');
        seatsList.innerHTML = '';
        booking.seats.forEach(seat => {
            const badge = document.createElement('div');
            badge.className = 'ticket-seat-badge';
            badge.textContent = `${seat.seatType} - Seat ${seat.seatNumber}`;
            seatsList.appendChild(badge);
        });

        // Generate barcode
        generateQRCode(booking.id);

        // Show modal
        document.getElementById('ticketModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function generateQRCode(bookingId) {
        // Clear previous QR code
        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = '';

        // Generate new QR code with booking ID
        new QRCode(qrcodeContainer, {
            text: bookingId,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });

        // Set QR code text
        document.getElementById('qrcodeText').textContent = `Booking ID: ${bookingId.substring(0, 16).toUpperCase()}`;
    }

    function closeTicketModal() {
        document.getElementById('ticketModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    function printTicket() {
        window.print();
    }

    function switchTab(tab) {
        currentTab = tab;

        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        displayBookings();
    }

    function browseEvents() {
        window.location.href = '/AllEvents';
    }

    function getUserId(user) {
        let userId = user.id;
        if (!userId && user._id) {
            if (typeof user._id === 'object' && user._id.$oid) {
                userId = user._id.$oid;
            } else if (typeof user._id === 'string') {
                userId = user._id;
            }
        }
        return userId;
    }

    function showSuccess(message) {
        const banner = document.getElementById('successBanner');
        const messageEl = document.getElementById('successMessage');

        messageEl.textContent = message;
        banner.classList.add('show');

        setTimeout(() => {
            hideSuccessBanner();
        }, 5000);
    }

    function hideSuccessBanner() {
        document.getElementById('successBanner').classList.remove('show');
    }

    // Close cancel modal when clicking outside
    document.getElementById('cancelModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCancelModal();
        }
    });

    // Close success dialog when clicking overlay
    document.getElementById('successDialogOverlay').addEventListener('click', function() {
        closeSuccessDialog();
    });

    // Close cancel modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (document.getElementById('cancelModal').classList.contains('active')) {
                closeCancelModal();
            }
            if (document.getElementById('successDialog').classList.contains('active')) {
                closeSuccessDialog();
            }
        }
    });

    // Close ticket modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('ticketModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeTicketModal();
            }
        });
    });

    function isEventPast(eventDate, eventTime) {
        if (!eventDate) return false;

        const eventDateTime = new Date(eventDate);
        const time = eventTime ? eventTime : '23:59';
        const [hours, minutes] = time.split(':');
        eventDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

        return eventDateTime < new Date();
    }

    // Auto-update booking status to "passed" if event has occurred
    async function checkAndUpdatePassedBookings() {
        let updated = false;

        for (const booking of allBookings) {
            // Only update confirmed bookings
            if (booking.status === 'confirmed') {
                const event = eventsCache[booking.eventId];
                if (event && isEventPast(event.eventDate, event.eventTime)) {
                    // Update status to "passed" via API
                    try {
                        const response = await fetch(`/api/bookings/${booking.id}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'passed' })
                        });

                        if (response.ok) {
                            booking.status = 'passed';
                            updated = true;
                        }
                    } catch (error) {
                        console.error('Error updating booking status:', error);
                    }
                }
            }
        }

        return updated;
    }

</script>
</body>
</html>

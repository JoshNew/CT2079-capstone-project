<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Sales - Event Ease</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fc;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .page-title {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #666;
            font-size: 1rem;
        }

        /* Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
        }

        .stat-subtext {
            color: #999;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .loading, .error-message, .no-data {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .loading {
            color: #667eea;
            font-size: 1.2rem;
        }

        /* Event Sales Cards */
        .events-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .events-grid {
            display: grid;
            gap: 1.5rem;
        }

        .event-sales-card {
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .event-sales-card:hover {
            border-color: #667eea;
            box-shadow: 0 3px 15px rgba(102, 126, 234, 0.2);
        }

        .event-sales-header {
            background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .event-info {
            flex: 1;
            min-width: 200px;
        }

        .event-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .event-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            color: #666;
            font-size: 0.9rem;
        }

        .event-revenue {
            text-align: right;
        }

        .revenue-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .revenue-amount {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
        }

        .event-sales-body {
            padding: 1.5rem;
        }

        .sales-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-box {
            background: #f8f9fc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .seat-breakdown {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }

        .breakdown-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
        }

        .seat-type-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8f9fc;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .seat-type-row:last-child {
            margin-bottom: 0;
        }

        .seat-type-name {
            font-weight: 600;
            color: #667eea;
        }

        .seat-stat {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }

        .seat-stat strong {
            color: #333;
            display: block;
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e1e1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .no-sales {
            text-align: center;
            padding: 2rem;
            color: #999;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 0 1rem;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }

            .event-sales-header {
                flex-direction: column;
            }

            .event-revenue {
                text-align: left;
            }

            .seat-type-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .seat-stat {
                text-align: left;
            }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo">Track Sales</div>
        <a href="/organizer-dashboard" class="back-btn">⬅ Back to Dashboard</a>
    </div>
</header>

<main class="main-content">
    <div class="page-header">
        <h1 class="page-title">Sales Analytics</h1>
        <p class="page-subtitle">Track your event performance and revenue</p>
    </div>

    <!-- Summary Stats -->
    <div class="summary-stats" id="summaryStats">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: #d1f4e0;">💰</div>
            </div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value" id="totalRevenue">$0</div>
            <div class="stat-subtext">All events</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: #e0f2fe;">🎫</div>
            </div>
            <div class="stat-label">Tickets Sold</div>
            <div class="stat-value" id="totalTickets">0</div>
            <div class="stat-subtext">Across all events</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: #fff3e0;">📊</div>
            </div>
            <div class="stat-label">Total Bookings</div>
            <div class="stat-value" id="totalBookings">0</div>
            <div class="stat-subtext">Confirmed bookings</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon" style="background: #f3e5f5;">🎉</div>
            </div>
            <div class="stat-label">Active Events</div>
            <div class="stat-value" id="activeEvents">0</div>
            <div class="stat-subtext">With sales</div>
        </div>
    </div>

    <div id="loadingMessage" class="loading">
        Loading sales data...
    </div>

    <div id="errorMessage" class="error-message" style="display: none;">
        <strong>Error:</strong> <span id="errorText">Unable to load sales data.</span>
        <br><br>
        <button class="back-btn" onclick="loadSalesData()" style="display: inline-block;">Retry</button>
    </div>

    <div id="noDataMessage" class="no-data" style="display: none;">
        <h3>No sales data yet</h3>
        <p style="margin-top: 0.5rem;">Create events and start selling tickets!</p>
    </div>

    <!-- Event Sales Cards -->
    <div id="eventsSection" class="events-section" style="display: none;">
        <h2 class="section-title">Event Sales Breakdown</h2>
        <div class="events-grid" id="eventsGrid">
            <!-- Event sales cards will be inserted here -->
        </div>
    </div>
</main>

<script>
    let currentUser = null;
    let eventsData = [];
    let bookingsData = [];

    window.addEventListener('load', function() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const userData = sessionStorage.getItem('user');

        if (!isLoggedIn || !userData) {
            window.location.href = '/';
            return;
        }

        currentUser = JSON.parse(userData);

        // Check if user is organizer
        if (currentUser.role !== 3) {
            alert('Access denied. Organizer privileges required.');
            window.location.href = '/';
            return;
        }

        loadSalesData();
    });

    async function loadSalesData() {
        try {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('eventsSection').style.display = 'none';

            const userId = getUserId(currentUser);

            // Load organizer's events
            const eventsResponse = await fetch(`/api/events/organizer/${userId}`);
            if (!eventsResponse.ok) throw new Error('Failed to fetch events');
            eventsData = await eventsResponse.json();

            // Load all bookings for these events
            const bookingPromises = eventsData.map(event =>
                fetch(`/api/bookings/event/${event.id}`)
                    .then(res => res.ok ? res.json() : [])
            );

            const allBookings = await Promise.all(bookingPromises);
            bookingsData = allBookings.flat();

            // Filter only confirmed and used bookings (not cancelled)
            bookingsData = bookingsData.filter(b => b.status === 'confirmed' || b.status === 'used');

            displaySalesData();

        } catch (error) {
            console.error('Error loading sales data:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = error.message;
        }
    }

    function displaySalesData() {
        document.getElementById('loadingMessage').style.display = 'none';

        // Calculate summary stats
        const totalRevenue = bookingsData.reduce((sum, b) => sum + b.totalPrice, 0);
        const totalTickets = bookingsData.reduce((sum, b) => sum + b.seats.length, 0);
        const totalBookings = bookingsData.length;
        const eventsWithSales = new Set(bookingsData.map(b => b.eventId)).size;

        // Update summary cards
        document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
        document.getElementById('totalTickets').textContent = totalTickets;
        document.getElementById('totalBookings').textContent = totalBookings;
        document.getElementById('activeEvents').textContent = `${eventsWithSales}/${eventsData.length}`;

        // Show events section or no data message
        if (eventsData.length === 0) {
            document.getElementById('noDataMessage').style.display = 'block';
            return;
        }

        document.getElementById('eventsSection').style.display = 'block';

        // Display individual event sales
        const eventsGrid = document.getElementById('eventsGrid');
        eventsGrid.innerHTML = '';

        eventsData.forEach(event => {
            const eventBookings = bookingsData.filter(b => b.eventId === event.id);
            const card = createEventSalesCard(event, eventBookings);
            eventsGrid.appendChild(card);
        });
    }

    function createEventSalesCard(event, bookings) {
        const card = document.createElement('div');
        card.className = 'event-sales-card';

        // Calculate metrics
        const totalRevenue = bookings.reduce((sum, b) => sum + b.totalPrice, 0);
        const totalTickets = bookings.reduce((sum, b) => sum + b.seats.length, 0);

        // Seat breakdown
        const seatStats = {
            VIP: { sold: 0, total: event.vipSeats?.totalSeats || 0, revenue: 0 },
            Standard: { sold: 0, total: event.standardSeats?.totalSeats || 0, revenue: 0 },
            Concession: { sold: 0, total: event.concessionSeats?.totalSeats || 0, revenue: 0 }
        };

        bookings.forEach(booking => {
            booking.seats.forEach(seat => {
                if (seatStats[seat.seatType]) {
                    seatStats[seat.seatType].sold++;
                    seatStats[seat.seatType].revenue += seat.price;
                }
            });
        });

        const eventDateTime = formatDateTime(event.eventDate, event.eventTime);

        // Build seat breakdown HTML
        let seatBreakdownHTML = '';
        Object.keys(seatStats).forEach(type => {
            const stats = seatStats[type];
            if (stats.total > 0) {
                const soldPercentage = (stats.sold / stats.total * 100).toFixed(1);
                seatBreakdownHTML += `
                        <div class="seat-type-row">
                            <div class="seat-type-name">${type}</div>
                            <div class="seat-stat">
                                <strong>${stats.sold}/${stats.total}</strong>
                                <small>Sold</small>
                            </div>
                            <div class="seat-stat">
                                <strong>${soldPercentage}%</strong>
                                <small>Fill Rate</small>
                            </div>
                            <div class="seat-stat">
                                <strong>$${stats.revenue.toFixed(2)}</strong>
                                <small>Revenue</small>
                            </div>
                        </div>
                    `;
            }
        });

        card.innerHTML = `
                <div class="event-sales-header">
                    <div class="event-info">
                        <div class="event-name">${event.name}</div>
                        <div class="event-meta">
                             <span>📍 ${event.location}</span>
                            <span>🗓️ ${eventDateTime}</span>
                            <span>🎭 ${event.category || 'Event'}</span>
                        </div>
                    </div>
                    <div class="event-revenue">
                        <div class="revenue-label">Total Revenue</div>
                        <div class="revenue-amount">$${totalRevenue.toFixed(2)}</div>
                    </div>
                </div>
                <div class="event-sales-body">
                    <div class="sales-metrics">
                        <div class="metric-box">
                            <div class="metric-value">${bookings.length}</div>
                            <div class="metric-label">Bookings</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${totalTickets}</div>
                            <div class="metric-label">Tickets Sold</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${calculateTotalSeats(event)}</div>
                            <div class="metric-label">Total Capacity</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${calculateFillRate(event, totalTickets)}%</div>
                            <div class="metric-label">Fill Rate</div>
                        </div>
                    </div>

                    ${seatBreakdownHTML ? `
                        <div class="seat-breakdown">
                            <div class="breakdown-title">Seat Type Breakdown</div>
                            ${seatBreakdownHTML}
                        </div>
                    ` : '<div class="no-sales">No seat data available</div>'}
                </div>
            `;

        return card;
    }

    function calculateTotalSeats(event) {
        let total = 0;
        if (event.vipSeats) total += event.vipSeats.totalSeats;
        if (event.standardSeats) total += event.standardSeats.totalSeats;
        if (event.concessionSeats) total += event.concessionSeats.totalSeats;
        return total;
    }

    function calculateFillRate(event, soldTickets) {
        const totalSeats = calculateTotalSeats(event);
        if (totalSeats === 0) return 0;
        return ((soldTickets / totalSeats) * 100).toFixed(1);
    }

    function formatDateTime(date, time) {
        if (!date) return 'Date TBA';

        const dateObj = new Date(date + 'T00:00:00');
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        const formattedDate = dateObj.toLocaleDateString('en-US', options);

        if (time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${formattedDate} at ${displayHour}:${minutes} ${ampm}`;
        }

        return formattedDate;
    }

    function getUserId(user) {
        let userId = user.id;
        if (!userId && user._id) {
            if (typeof user._id === 'object' && user._id.$oid) {
                userId = user._id.$oid;
            } else if (typeof user._id === 'string') {
                userId = user._id;
            }
        }
        return userId;
    }
</script>
</body>
</html>

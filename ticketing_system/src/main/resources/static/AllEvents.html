<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Ease - Discover Amazing Events</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fc;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        #userInfoSection {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .login-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }

        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .page-title {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #666;
            font-size: 1rem;
        }

        /* Advertisement Banner */
        .ad-banner-container {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            display: none;
        }

        .ad-banner {
            position: relative;
            width: 100%;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .ad-slide {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ad-slide.active {
            opacity: 1;
        }

        .ad-slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .ad-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 10;
        }

        .ad-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 1rem;
        }

        .ad-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .ad-indicator.active {
            background: #667eea;
        }

        /* Search and Filter */
        .search-filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 3rem;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .clear-search-btn {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .clear-search-btn.show {
            opacity: 1;
            pointer-events: all;
        }

        .clear-search-btn:hover {
            color: #667eea;
        }

        .search-results-count {
            text-align: center;
            color: #666;
            margin-bottom: 1rem;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e1e1e1;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        /* Events Grid */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .event-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .event-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            overflow: hidden;
        }

        .event-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .event-content {
            padding: 1.5rem;
        }

        .organizer-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .organizer-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            overflow: hidden;
        }

        .organizer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .organizer-details {
            flex: 1;
        }

        .organizer-label {
            font-size: 0.75rem;
            color: #999;
        }

        .organizer-name {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
        }

        .event-name {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .event-category {
            display: inline-block;
            background: #eef2ff;
            color: #667eea;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .event-location, .event-datetime {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .event-description {
            color: #666;
            font-size: 0.9rem;
            margin: 1rem 0;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-seats {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem 0;
            border-top: 1px solid #f0f0f0;
        }

        .seat-info {
            flex: 1;
            background: #f8f9fc;
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
        }

        .seat-type {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .seat-price {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9rem;
        }

        .seat-available {
            font-size: 0.75rem;
            color: #10b981;
        }

        .event-action {
            padding-top: 1rem;
            border-top: 1px solid #f0f0f0;
        }

        .view-details-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .view-details-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #999;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 0 1rem;
            }

            .events-grid {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .ad-banner {
                height: 150px;
            }
        }
        .logo img {
            max-height: 36px;
            max-width: 180px;
            object-fit: contain;
        }

        .past-events-btn {
            background: #f3f4f6 !important;
            color: #6b7280 !important;
            border-color: #d1d5db !important;
        }

        .past-events-btn:hover {
            background: #e5e7eb !important;
            border-color: #9ca3af !important;
        }

        .past-events-btn.active {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
            color: white !important;
            border-color: transparent !important;
        }
        /* Admin Restriction Modal */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .admin-modal.active {
            display: flex;
        }

        .admin-modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .admin-modal-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
        }

        .admin-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .admin-modal-message {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .admin-modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .admin-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .price-filter-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8f9fc;
            border-radius: 8px;
        }

        .price-filter-container label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 1rem;
            color: #333;
            text-align: center;
        }

        .slider-container {
            position: relative;
            height: 40px;
            width: 100%;
        }

        /* Base track background (gray) */
        .slider-container::after {
            content: '';
            position: absolute;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            top: 16px;
            left: 0;
            right: 0;
            pointer-events: none;
            z-index: 0;
        }

        /* Active range (gradient) */
        .slider-container::before {
            content: '';
            position: absolute;
            height: 8px;
            background: linear-gradient(to right, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            top: 16px;
            left: var(--min-percent, 0%);
            right: calc(100% - var(--max-percent, 100%));
            pointer-events: none;
            z-index: 1;
        }

        .slider-container input[type="range"] {
            position: absolute;
            width: 100%;
            height: 8px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            appearance: none;
            top: 16px;
        }

        /* HIDE the default track */
        .slider-container input[type="range"]::-webkit-slider-runnable-track {
            background: transparent;
            border: none;
        }

        .slider-container input[type="range"]::-moz-range-track {
            background: transparent;
            border: none;
        }

        /* Style only the thumbs */
        .slider-container input[type="range"]::-webkit-slider-thumb {
            pointer-events: all;
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 3;
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            pointer-events: all;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 3;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            border-color: #764ba2;
        }

        .slider-container input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
            border-color: #764ba2;
        }

        .slider-container input[type="range"]:focus {
            outline: none;
        }

        /* Min slider on top */
        #priceSliderMin {
            z-index: 2;
        }

        /* Max slider below */
        #priceSliderMax {
            z-index: 1;
        }

        .seat-type-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .seat-type-btn {
            padding: 0.5rem 1.2rem;
            border: 2px solid #e1e1e1;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
        }

        .seat-type-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .seat-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .seat-type-btn.vip.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .seat-type-btn.standard.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .seat-type-btn.concession.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo" id="logoContainer">Event Ease</div>
        <div class="header-actions">
            <div id="userInfoSection" style="display: none;">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span id="userName"></span>
                </div>
                <a href="#" id="backBtn" class="back-btn">Dashboard</a>
            </div>
            <div id="loginSection">
                <a href="/login" class="login-btn">Login / Sign Up</a>
            </div>
        </div>
    </div>
</header>

<main class="main-content">
    <div class="page-header">
        <h1 class="page-title">Welcome to Event Ease</h1>
        <p class="page-subtitle">Discover amazing events happening near you</p>
    </div>

    <!-- Advertisement Banner -->
    <div class="ad-banner-container" id="adBannerContainer" style="display: none;">
        <div class="ad-banner" id="adBanner">
            <div class="ad-label">Advertisement</div>
            <!-- Ads will be loaded dynamically from localStorage -->
        </div>
        <div class="ad-indicators" id="adIndicators">
            <!-- Indicators will be loaded dynamically -->
        </div>
    </div>

    <div class="search-filter-section">
        <div class="search-bar">
            <div class="search-input-wrapper">
                <span class="search-icon">🔍</span>
                <input
                        type="text"
                        id="searchInput"
                        class="search-input"
                        placeholder="Search events by name, location, date, or description..."
                        oninput="searchEvents()"
                >
                <button class="clear-search-btn" id="clearSearchBtn" onclick="clearSearch()">X</button>
            </div>
        </div>
        <div class="search-results-count" id="searchResultsCount">
            Showing <strong id="eventCount">0</strong> events
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterByCategory('All')">All</button>
            <button class="filter-btn" onclick="filterByCategory('Concert')">Concert</button>
            <button class="filter-btn" onclick="filterByCategory('Sports')">Sports</button>
            <button class="filter-btn" onclick="filterByCategory('Theater')">Theater</button>
            <button class="filter-btn" onclick="filterByCategory('Conference')">Conference</button>
            <button class="filter-btn" onclick="filterByCategory('Cultural events')">Cultural events</button>
            <button class="filter-btn" onclick="filterByCategory('Workshop')">Workshop</button>
            <button class="filter-btn" onclick="filterByCategory('Other')">Other</button>
            <button class="filter-btn past-events-btn" onclick="filterByCategory('Past Events')">Past Events</button>
        </div>
        <div class="price-filter-container">
            <label>Price Range: $<span id="priceMinDisplay">0</span> - $<span id="priceMaxDisplay">1000</span></label>
            <div class="slider-container">
                <input type="range" id="priceSliderMin" min="0" max="1000" value="0" step="10" oninput="updatePriceRangeMin()">
                <input type="range" id="priceSliderMax" min="0" max="1000" value="1000" step="10" oninput="updatePriceRangeMax()">
            </div>

            <div class="seat-type-buttons">
                <button class="seat-type-btn vip" onclick="filterBySeatType('vip')">
                    VIP
                </button>
                <button class="seat-type-btn standard" onclick="filterBySeatType('standard')">
                    Standard
                </button>
                <button class="seat-type-btn concession active" onclick="filterBySeatType('concession')">
                    Concession
                </button>
            </div>
        </div>

    <div id="loadingMessage" class="loading">
        Loading events...
    </div>

    <div id="errorMessage" class="error-message" style="display: none;">
        <strong>Error:</strong> <span id="errorText">Unable to load events.</span>
        <br><br>
        <button class="view-details-btn" onclick="loadEvents()" style="max-width: 200px; margin: 1rem auto;">Retry</button>
    </div>

    <div id="noDataMessage" class="no-data" style="display: none;">
        No events found. Check back later!
    </div>

    <div id="eventsGrid" class="events-grid" style="display: none;">
        <!-- Event cards will be inserted here -->
    </div>
    <!-- Admin Restriction Modal -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-icon">🚫</div>
            <h2 class="admin-modal-title">Admin View Only</h2>
            <p class="admin-modal-message">
                As an administrator, you can view event details but cannot book tickets.
                This is a view-only mode for administrative purposes.
            </p>
            <button class="admin-modal-btn" onclick="closeAdminModal()">
                I Understand
            </button>
        </div>
    </div>
    </div>
</main>

<script>

    //Global var
    let currentUser = null;
    let allEvents = [];
    let filteredEvents = [];
    let organizersCache = {};
    let currentFilter = 'All';
    let currentSlide = 0;
    let adSlides = [];
    let adInterval;
    let showPastEvents = false;
    let currentSeatType = 'concession';

    // Load events on page load
    window.addEventListener('load', function() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const userData = sessionStorage.getItem('user');

        if (isLoggedIn && userData) {
            currentUser = JSON.parse(userData);

            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userInfoSection').style.display = 'flex';

            const avatarContainer = document.getElementById('userAvatar');
            if (currentUser.avatarImage) {
                avatarContainer.innerHTML = `<img src="${currentUser.avatarImage}" alt="Avatar">`;
            } else {
                avatarContainer.textContent = currentUser.name.charAt(0).toUpperCase();
            }
            document.getElementById('userName').textContent = currentUser.name;

            setBackButtonUrl(currentUser.role);
        } else {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('userInfoSection').style.display = 'none';
        }

        // Initialize advertisement slider
        initAdSlider();

        // Load events
        loadEvents();
    });

    function setBackButtonUrl(role) {
        const backBtn = document.getElementById('backBtn');

        switch(role) {
            case 1:
                backBtn.href = '/admin-dashboard';
                backBtn.textContent = 'Admin Dashboard';
                break;
            case 2:
                backBtn.href = '/customer-dashboard';
                backBtn.textContent = 'My Dashboard';
                break;
            case 4:
                backBtn.href = '/customer-dashboard';
                backBtn.textContent = 'My Dashboard';
                break;
            case 3:
                backBtn.href = '/organizer-dashboard';
                backBtn.textContent = 'Organizer Dashboard';
                break;
            default:
                backBtn.href = '/AllEvent';
                backBtn.textContent = 'Dashboard';
                break;
        }
    }

    // Advertisement Functions
    function initAdSlider() {
        loadAdvertisements();
    }

    async function loadAdvertisements() {
        try {
            const response = await fetch('/api/advertisements/active');

            if (!response.ok) {
                hideAdContainer();
                return;
            }

            const ads = await response.json();
            const adBanner = document.getElementById('adBanner');
            const adIndicators = document.getElementById('adIndicators');
            const adContainer = document.getElementById('adBannerContainer');

            if (!ads || ads.length === 0) {
                hideAdContainer();
                return;
            }

            // Show ad container
            if (adContainer) {
                adContainer.style.display = 'block';
            }

            // Clear existing content
            adBanner.innerHTML = '<div class="ad-label">Advertisement</div>';
            adIndicators.innerHTML = '';

            // Create slides from API ads
            ads.forEach((ad, index) => {
                const slide = document.createElement('div');
                slide.className = 'ad-slide' + (index === 0 ? ' active' : '');
                slide.innerHTML = `<img src="${ad.imageData}" alt="${ad.name}">`;
                adBanner.appendChild(slide);

                const indicator = document.createElement('span');
                indicator.className = 'ad-indicator' + (index === 0 ? ' active' : '');
                indicator.onclick = () => goToSlide(index);
                adIndicators.appendChild(indicator);
            });

            adSlides = document.querySelectorAll('.ad-slide');

            // Start auto-rotation if more than one ad
            if (adSlides.length > 1) {
                startAdRotation();
            }
        } catch (error) {
            console.error('Error loading advertisements:', error);
            hideAdContainer();
        }
    }

    function hideAdContainer() {
        const adContainer = document.getElementById('adBannerContainer');
        if (adContainer) {
            adContainer.style.display = 'none';
        }
    }

    function startAdRotation() {
        if (adInterval) {
            clearInterval(adInterval);
        }
        adInterval = setInterval(() => {
            nextSlide();
        }, 5000); // Change this to change timing
    }

    function nextSlide() {
        goToSlide((currentSlide + 1) % adSlides.length);
    }

    function goToSlide(index) {
        if (adSlides.length === 0) return;

        // Remove active class from current slide and indicator
        adSlides[currentSlide].classList.remove('active');
        const indicators = document.querySelectorAll('.ad-indicator');
        if (indicators[currentSlide]) {
            indicators[currentSlide].classList.remove('active');
        }

        // Set new current slide
        currentSlide = index;

        // Add active class to new slide and indicator
        adSlides[currentSlide].classList.add('active');
        if (indicators[currentSlide]) {
            indicators[currentSlide].classList.add('active');
        }

        // Reset interval
        if (adSlides.length > 1) {
            clearInterval(adInterval);
            startAdRotation();
        }
    }

    async function loadEvents() {
        try {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('eventsGrid').style.display = 'none';

            const response = await fetch('/api/events');

            if (!response.ok) {
                throw new Error('Failed to fetch events');
            }

            allEvents = await response.json();

            //FILTER OUT PAST EVENTS BY DEFAULT
            allEvents = allEvents.filter(event => !isEventPast(event));

            // Sort events by earliest date
            allEvents.sort((a, b) => {
                const dateA = new Date(a.eventDate || '9999-12-31');
                const dateB = new Date(b.eventDate || '9999-12-31');
                return dateA - dateB;
            });

            const uniqueOrganizerIds = [...new Set(allEvents.map(event => event.organizerId))];
            await Promise.all(uniqueOrganizerIds.map(id => fetchOrganizerData(id)));

            filteredEvents = allEvents;
            displayEvents(filteredEvents);

        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = error.message;
        }
    }

    async function fetchOrganizerData(organizerId) {
        if (organizersCache[organizerId]) return;

        try {
            const response = await fetch(`/api/users/${organizerId}`);
            if (response.ok) {
                const organizer = await response.json();
                organizersCache[organizerId] = organizer;
            }
        } catch (error) {
            console.error('Error fetching organizer data:', error);
            organizersCache[organizerId] = {
                name: 'Unknown Organizer',
                avatarImage: null
            };
        }
    }

    function displayEvents(events) {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('eventCount').textContent = events.length;

        if (events.length === 0) {
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('eventsGrid').style.display = 'none';
            document.getElementById('eventsGrid').innerHTML = ''; // Clear any existing events
            return;
        }

        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('eventsGrid').style.display = 'grid';

        const eventsGrid = document.getElementById('eventsGrid');
        eventsGrid.innerHTML = '';

        events.forEach(event => {
            const card = createEventCard(event);
            eventsGrid.appendChild(card);
        });
    }

    function createEventCard(event) {
        const card = document.createElement('div');
        card.className = 'event-card';

        const minPrice = getEventMinPrice(event);
        card.setAttribute('data-price', minPrice);

        const eventImage = event.eventImage
            ? `<img src="${event.eventImage}" alt="${event.name}">`
            :' 🎉';

        const organizer = organizersCache[event.organizerId] || { name: 'Unknown', avatarImage: null };
        const organizerAvatarContent = organizer.avatarImage
            ? `<img src="${organizer.avatarImage}" alt="${organizer.name}">`
            : organizer.name.charAt(0).toUpperCase();

        const vipInfo = event.vipSeats ? `
        <div class="seat-info">
            <div class="seat-type">VIP</div>
            <div class="seat-price">$${event.vipSeats.price.toFixed(2)}</div>
            <div class="seat-available">${event.vipSeats.availableSeats} left</div>
        </div>
    ` : '';

        const standardInfo = event.standardSeats ? `
        <div class="seat-info">
            <div class="seat-type">Standard</div>
            <div class="seat-price">$${event.standardSeats.price.toFixed(2)}</div>
            <div class="seat-available">${event.standardSeats.availableSeats} left</div>
        </div>
    ` : '';

        const concessionInfo = event.concessionSeats ? `
        <div class="seat-info">
            <div class="seat-type">Concession</div>
            <div class="seat-price">$${event.concessionSeats.price.toFixed(2)}</div>
            <div class="seat-available">${event.concessionSeats.availableSeats} left</div>
        </div>
    ` : '';

        const eventDateTime = formatDateTime(event.eventDate, event.eventTime);
        const isAdmin = currentUser && currentUser.role === 1;
        const buttonText = isAdmin ? 'View Details Only' : 'View Details & Book';
        const imageClickable = !isAdmin;

        card.innerHTML = `
        <div class="event-image" style="cursor: ${imageClickable ? 'pointer' : 'default'};" ${imageClickable ? `onclick="window.location.href='booking.html?eventId=${event.id}'"` : ''}>
            ${eventImage}
        </div>
        <div class="event-content">
            <div class="organizer-info">
                <div class="organizer-avatar">${organizerAvatarContent}</div>
                <div class="organizer-details">
                    <div class="organizer-label">Organized by</div>
                    <div class="organizer-name">${organizer.name}</div>
                </div>
            </div>
            <h3 class="event-name">${event.name}</h3>
            <span class="event-category">${event.category || 'Uncategorized'}</span>
            <div class="event-location">📍 ${event.location}</div>
            <div class="event-datetime">🗓️ ${eventDateTime}</div>
            <p class="event-description">${event.description || 'No description provided'}</p>
            <div class="event-seats">
                ${vipInfo}
                ${standardInfo}
                ${concessionInfo}
            </div>
            <div class="event-action">
                <button class="view-details-btn" ${isAdmin ? 'style="background: #6b7280; cursor: not-allowed;"' : ''}>
    ${buttonText}
</button>
            </div>
        </div>
    `;

        const button = card.querySelector('.view-details-btn');
        button.addEventListener('click', function() {
            // Prevent admins from booking
            if (isAdmin) {
                showAdminModal();
                return;
            }
            window.location.href = `booking.html?eventId=${event.id}`;
        });

        return card;
    }
    function formatDateTime(date, time) {
        if (!date) return 'Date TBA';

        // Force Singapore timezone
        const dateObj = new Date(date + 'T00:00:00+08:00');
        const options = {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            timeZone: 'Asia/Singapore'
        };
        const formattedDate = dateObj.toLocaleDateString('en-US', options);

        if (time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${formattedDate} at ${displayHour}:${minutes} ${ampm}`;
        }

        return formattedDate;
    }

    async function filterByCategory(category) {
        currentFilter = category;

        const buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
        });

        // Find and activate the clicked button
        buttons.forEach(btn => {
            if (btn.textContent.trim().includes(category) ||
                (category === 'All' && btn.textContent.trim() === 'All')) {
                btn.classList.add('active');
            }
        });

        // HANDLE PAST EVENTS FILTER
        if (category === 'Past Events') {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('eventsGrid').style.display = 'none';

                const response = await fetch('/api/events');
                if (!response.ok) throw new Error('Failed to fetch events');

                const allEventsData = await response.json();

                // Filter to show ONLY past events
                filteredEvents = allEventsData.filter(event => isEventPast(event));

                // Sort by most recent first
                filteredEvents.sort((a, b) => {
                    const dateA = new Date(a.eventDate || '1970-01-01');
                    const dateB = new Date(b.eventDate || '1970-01-01');
                    return dateB - dateA; // Most recent past events first
                });

                // Fetch organizer data for past events
                const uniqueOrganizerIds = [...new Set(filteredEvents.map(event => event.organizerId))];
                await Promise.all(uniqueOrganizerIds.map(id => fetchOrganizerData(id)));

                document.getElementById('loadingMessage').style.display = 'none';
                displayEvents(filteredEvents);
                return;

            } catch (error) {
                console.error('Error loading past events:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }
        }

        // FOR OTHER CATEGORIES - EXCLUDE PAST EVENTS
        if (category === 'All') {
            filteredEvents = allEvents;
        } else {
            filteredEvents = allEvents.filter(event => event.category === category);
        }

        const searchTerm = document.getElementById('searchInput').value.trim();
        if (searchTerm) {
            filteredEvents = filteredEvents.filter(event =>
                event.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                event.location.toLowerCase().includes(searchTerm.toLowerCase()) ||
                event.description?.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }

        displayEvents(filteredEvents);
    }

    function searchInDate(eventDate, eventTime, searchTerm) {
        if (!eventDate) return false;

        // Create full formatted date string for searching
        const dateObj = new Date(eventDate + 'T00:00:00');

        // Get various date formats
        const fullDate = eventDate; // YYYY-MM-DD format
        const year = dateObj.getFullYear().toString();
        const monthNumber = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const dayNumber = dateObj.getDate().toString().padStart(2, '0');

        // Month names
        const monthNames = [
            'january', 'february', 'march', 'april', 'may', 'june',
            'july', 'august', 'september', 'october', 'november', 'december'
        ];
        const monthShortNames = [
            'jan', 'feb', 'mar', 'apr', 'may', 'jun',
            'jul', 'aug', 'sep', 'oct', 'nov', 'dec'
        ];

        const monthName = monthNames[dateObj.getMonth()];
        const monthShortName = monthShortNames[dateObj.getMonth()];

        // Day name
        const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayShortNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
        const dayName = dayNames[dateObj.getDay()];
        const dayShortName = dayShortNames[dateObj.getDay()];

        // Formatted date string (e.g., "Mar 15 2025")
        const formattedDate = formatDateTime(eventDate, eventTime).toLowerCase();

        // Check all possible date matches
        return (
            fullDate.includes(searchTerm) ||              // YYYY-MM-DD
            year.includes(searchTerm) ||                   // 2025
            monthNumber.includes(searchTerm) ||            // 03
            dayNumber.includes(searchTerm) ||              // 15
            monthName.includes(searchTerm) ||              // march
            monthShortName.includes(searchTerm) ||         // mar
            dayName.includes(searchTerm) ||                // monday
            dayShortName.includes(searchTerm) ||           // mon
            formattedDate.includes(searchTerm) ||          // full formatted string
            searchTerm.includes(year) ||                   // if user types "2025"
            searchTerm.includes(monthName) ||              // if user types "march"
            searchTerm.includes(monthShortName)            // if user types "mar"
        );
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearchBtn').classList.remove('show');
        filterByCategory(currentFilter);
    }

    function viewEventDetails(eventId) {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');

        if (!isLoggedIn) {
            sessionStorage.setItem('redirectAfterLogin', `/booking.html?eventId=${eventId}`);
            window.location.href = '/login';
            return;
        }

        window.location.href = `/booking.html?eventId=${eventId}`;
    }
    // Load logo from database
    async function loadLogo() {
        try {
            const response = await fetch('/api/logo');
            if (response.ok) {
                const logo = await response.json();
                if (logo && logo.imageData) {
                    const logoContainer = document.getElementById('logoContainer');
                    logoContainer.innerHTML = `<img src="${logo.imageData}" alt="Event Ease Logo">`;
                }
            }
        } catch (error) {
            console.error('Error loading logo:', error);
        }
    }

    // Call loadLogo when page loads
    window.addEventListener('DOMContentLoaded', loadLogo);

    function isEventPast(event) {
        if (!event.eventDate) return false;

        // Use Singapore timezone for comparison
        const eventTime = event.eventTime ? event.eventTime : '23:59';
        const [hours, minutes] = eventTime.split(':');

        // Create event datetime in Singapore timezone
        const eventDateTimeStr = `${event.eventDate}T${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:00+08:00`;
        const eventDateTime = new Date(eventDateTimeStr);

        // Get current time in Singapore timezone
        const nowSingapore = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Singapore' }));

        return eventDateTime < nowSingapore;
    }
    // Admin Modal Functions
    function showAdminModal() {
        document.getElementById('adminModal').classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeAdminModal() {
        document.getElementById('adminModal').classList.remove('active');
        document.body.style.overflow = 'auto'; // Restore scrolling
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('adminModal');
        if (e.target === modal) {
            closeAdminModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('adminModal');
            if (modal && modal.classList.contains('active')) {
                closeAdminModal();
            }
        }
    });

    function updatePriceRangeMin() {
        const minSlider = document.getElementById('priceSliderMin');
        const maxSlider = document.getElementById('priceSliderMax');
        const minDisplay = document.getElementById('priceMinDisplay');

        let minValue = parseInt(minSlider.value);
        let maxValue = parseInt(maxSlider.value);

        // Ensure min doesn't exceed max
        if (minValue > maxValue - 50) {
            minValue = maxValue - 50;
            minSlider.value = minValue;
        }

        minDisplay.textContent = minValue;

        // Update the visual range
        updateSliderRange(minValue, maxValue);

        // Filter events
        filterEventsByPriceRange(minValue, maxValue);
    }

    function updatePriceRangeMax() {
        const minSlider = document.getElementById('priceSliderMin');
        const maxSlider = document.getElementById('priceSliderMax');
        const maxDisplay = document.getElementById('priceMaxDisplay');

        let minValue = parseInt(minSlider.value);
        let maxValue = parseInt(maxSlider.value);

        // Ensure max doesn't go below min
        if (maxValue < minValue + 50) {
            maxValue = minValue + 50;
            maxSlider.value = maxValue;
        }

        maxDisplay.textContent = maxValue;

        // Update the visual range
        updateSliderRange(minValue, maxValue);

        // Filter events
        filterEventsByPriceRange(minValue, maxValue);
    }

    function updateSliderRange(min, max) {
        const sliderContainer = document.querySelector('.slider-container');
        const maxRange = 1000;
        const minPercent = (min / maxRange) * 100;
        const maxPercent = (max / maxRange) * 100;

        // Update the colored range
        sliderContainer.style.setProperty('--min-percent', minPercent + '%');
        sliderContainer.style.setProperty('--max-percent', maxPercent + '%');
    }

    function filterEventsByPriceRange(minPrice, maxPrice) {
        const searchValue = document.getElementById('searchInput')?.value.toLowerCase() || '';

        // Start with current filtered events based on category
        let eventsToFilter = filteredEvents;

        // Apply search filter if exists
        if (searchValue) {
            eventsToFilter = eventsToFilter.filter(event =>
                event.name.toLowerCase().includes(searchValue) ||
                event.location.toLowerCase().includes(searchValue) ||
                event.description?.toLowerCase().includes(searchValue)
            );
        }

        // Apply price filter based on selected seat type
        const priceFilteredEvents = eventsToFilter.filter(event => {
            let eventPrice = 0;

            // Get price based on current seat type selection
            if (currentSeatType === 'vip' && event.vipSeats) {
                eventPrice = event.vipSeats.price;
            } else if (currentSeatType === 'standard' && event.standardSeats) {
                eventPrice = event.standardSeats.price;
            } else if (currentSeatType === 'concession' && event.concessionSeats) {
                eventPrice = event.concessionSeats.price;
            } else {
                // If the event doesn't have the selected seat type, use minimum price
                eventPrice = getEventMinPrice(event);
            }

            return eventPrice >= minPrice && eventPrice <= maxPrice;
        });

        displayEvents(priceFilteredEvents);
    }

    // Update the existing getEventMinPrice function (keep as is)
    function getEventMinPrice(event) {
        const prices = [];
        if (event.vipSeats) prices.push(event.vipSeats.price);
        if (event.standardSeats) prices.push(event.standardSeats.price);
        if (event.concessionSeats) prices.push(event.concessionSeats.price);

        return prices.length > 0 ? Math.min(...prices) : 0;
    }

    function resetAllFilters() {
        // Reset search input if exists
        if (document.getElementById('searchInput')) {
            document.getElementById('searchInput').value = '';
        }

        // Reset price sliders
        document.getElementById('priceSliderMin').value = 0;
        document.getElementById('priceSliderMax').value = 1000;
        document.getElementById('priceMinDisplay').textContent = 0;
        document.getElementById('priceMaxDisplay').textContent = 1000;

        // Update visual range
        updateSliderRange(0, 1000);

        // Reset to concession (default)
        currentSeatType = 'concession';
        document.querySelectorAll('.seat-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.seat-type-btn.concession').classList.add('active');

        // Reset to current category filter
        filterByCategory(currentFilter);
    }

    function searchEvents() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const clearBtn = document.getElementById('clearSearchBtn');

        if (searchTerm) {
            clearBtn.classList.add('show');
        } else {
            clearBtn.classList.remove('show');
        }

        if (!searchTerm) {
            filterByCategory(currentFilter);
            return;
        }

        // SEARCH WITHIN CURRENT FILTER
        let events = currentFilter === 'Past Events' ?
            [] : // Past events are loaded separately
            (currentFilter === 'All' ? allEvents : allEvents.filter(e => e.category === currentFilter));

        filteredEvents = events.filter(event => {
            // Search by name, location, description
            const textMatch =
                event.name.toLowerCase().includes(searchTerm) ||
                event.location.toLowerCase().includes(searchTerm) ||
                (event.description && event.description.toLowerCase().includes(searchTerm));

            // Search by date
            const dateMatch = searchInDate(event.eventDate, event.eventTime, searchTerm);

            return textMatch || dateMatch;
        });

        displayEvents(filteredEvents);
    }

    function filterBySeatType(seatType) {
        currentSeatType = seatType;

        // Update button states
        document.querySelectorAll('.seat-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Get current price range
        const minPrice = parseInt(document.getElementById('priceSliderMin').value);
        const maxPrice = parseInt(document.getElementById('priceSliderMax').value);

        // Re-filter events with the new seat type
        filterEventsByPriceRange(minPrice, maxPrice);
    }

</script>
</body>
</html>

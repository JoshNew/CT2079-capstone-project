<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Event Ease</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 1.8rem;
        }

        .back-btn {
            padding: 0.6rem 1.2rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #5568d3;
        }

        .profile-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            text-align: center;
            color: white;
            position: relative;
        }

        .profile-avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #667eea;
            border: 4px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            position: relative;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background: #667eea;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-upload-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .avatar-upload-btn::before {
            content: '📷';
            font-size: 1rem;
        }

        #avatarInput {
            display: none;
        }

        .profile-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .profile-role {
            font-size: 0.9rem;
            opacity: 0.9;
            padding: 0.3rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: inline-block;
        }

        .profile-body {
            padding: 2rem;
        }

        .info-section {
            margin-bottom: 2rem;
        }

        .info-section h3 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .info-row {
            display: flex;
            padding: 1rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #555;
            width: 150px;
            flex-shrink: 0;
        }

        .info-value {
            color: #333;
            flex: 1;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-orange {
            background: #ff8c42;
            color: white;
        }

        .btn-orange:hover {
            background: #ff7a29;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 140, 66, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: white;
            font-size: 1.2rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e1e1;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Confirmation Modal Specific Styles */
        .confirm-modal-content {
            text-align: center;
        }

        .confirm-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .confirm-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .confirm-message {
            color: #666;
            line-height: 1.6;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .confirm-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-confirm {
            padding: 0.75rem 2rem;
            background: #ff8c42;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirm:hover {
            background: #ff7a29;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 140, 66, 0.4);
        }

        .btn-cancel {
            padding: 0.75rem 2rem;
            background: #f0f0f0;
            color: #555;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        /* Avatar Upload Modal */
        .avatar-preview-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .avatar-preview {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid #667eea;
            margin: 0 auto 1rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview-text {
            font-size: 4rem;
            color: #667eea;
            font-weight: bold;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .file-input-btn {
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .file-input-btn:hover {
            background: #5568d3;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .file-name {
            display: block;
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .remove-avatar-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            transition: background 0.3s ease;
        }

        .remove-avatar-btn:hover {
            background: #dc2626;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .info-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .info-label {
                width: 100%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .confirm-actions {
                flex-direction: column;
            }

            .btn-confirm,
            .btn-cancel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>My Profile</h1>
        <a href="#" id="backBtn" class="back-btn">⬅ Back to Dashboard</a>
    </div>

    <div id="loadingMessage" class="loading">
        Loading your profile...
    </div>

    <div id="profileContent" style="display: none;">
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <div class="profile-avatar" id="userAvatar">
                        <span id="avatarLetter">U</span>
                    </div>
                    <div class="avatar-upload-btn" onclick="openAvatarModal()" title="Change avatar"></div>
                </div>
                <h2 id="userName">User Name</h2>
                <span class="profile-role" id="userRole">Customer</span>
            </div>

            <div class="profile-body">
                <div id="updateSuccess" class="success-message" style="display: none;">
                    Profile updated successfully!
                </div>

                <div class="info-section">
                    <h3>Personal Information</h3>
                    <div class="info-row">
                        <span class="info-label">Full Name:</span>
                        <span class="info-value" id="displayName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value" id="displayEmail">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Account Type:</span>
                        <span class="info-value" id="displayRole">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">User ID:</span>
                        <span class="info-value" id="displayUserId">-</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openEditModal()">Edit Profile</button>
                    <button class="btn btn-orange" onclick="showOrgRequestModal()">Request for Organizer account</button>
                </div>
            </div>
        </div>
    </div>

    <div id="errorMessage" style="display: none;">
        <div class="profile-card">
            <div class="profile-body">
                <div class="error-message">
                    <strong>Error:</strong> <span id="errorText">Unable to load profile data.</span>
                </div>
                <button class="btn btn-primary" onclick="loadUserProfile()">Retry</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Profile</h3>
        </div>
        <div id="modalError" class="error-message" style="display: none;">
            <span id="modalErrorText"></span>
        </div>
        <form id="editForm">
            <div class="form-group">
                <label for="editName">Full Name</label>
                <input type="text" id="editName" name="name" required>
            </div>
            <div class="form-group">
                <label for="editEmail">Email Address</label>
                <input type="email" id="editEmail" name="email" required>
            </div>
            <div class="form-group">
                <label for="editPassword">New Password (leave blank to keep current)</label>
                <input type="password" id="editPassword" name="password" placeholder="Enter new password">
                <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 0.3rem;">
                    Password must be at least 6 characters long
                </small>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Avatar Upload Modal -->
<div id="avatarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Avatar</h3>
        </div>
        <div class="avatar-preview-container">
            <div class="avatar-preview" id="avatarPreview">
                <span class="avatar-preview-text" id="previewLetter">U</span>
            </div>
            <div class="file-input-wrapper">
                <label class="file-input-btn">
                    Choose Image
                    <input type="file" id="avatarFileInput" accept="image/*" onchange="previewAvatar(event)">
                </label>
            </div>
            <span class="file-name" id="fileName">No file chosen</span>
            <br>
            <button class="remove-avatar-btn" onclick="removeAvatar()" id="removeAvatarBtn" style="display: none;">
                Remove Avatar
            </button>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="saveAvatar()">Save Avatar</button>
            <button type="button" class="btn btn-secondary" onclick="closeAvatarModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Organizer Request Confirmation Modal -->
<div id="orgRequestModal" class="modal">
    <div class="modal-content confirm-modal-content">
        <div class="confirm-icon">🎭</div>
        <h2 class="confirm-title">Request Organizer Account</h2>
        <p class="confirm-message">
            Are you sure you want to request an organizer account?
            <br><br>
            Your request will be reviewed by an administrator. Once approved, you'll be able to create and manage events on the platform.
        </p>
        <div class="confirm-actions">
            <button class="btn-confirm" onclick="confirmOrgRequest()">Yes, Submit Request</button>
            <button class="btn-cancel" onclick="closeOrgRequestModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Remove Avatar Confirmation Modal -->
<div id="removeAvatarModal" class="modal">
    <div class="modal-content confirm-modal-content">
        <div class="confirm-icon">🗑️</div>
        <h2 class="confirm-title">Remove Avatar</h2>
        <p class="confirm-message">
            Are you sure you want to remove your profile picture?
            <br><br>
            Your avatar will be replaced with your initial letter. You can upload a new one anytime.
        </p>
        <div class="confirm-actions">
            <button class="btn-confirm" style="background: #ef4444;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" onclick="confirmRemoveAvatar()">Yes, Remove Avatar</button>
            <button class="btn-cancel" onclick="closeRemoveAvatarModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    let currentUser = null;
    let selectedAvatarImage = null;

    // Load user profile on page load
    window.addEventListener('load', function() {
        loadUserProfile();
    });

    async function loadUserProfile() {
        try {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('profileContent').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';

            const userDataStr = sessionStorage.getItem('user');
            console.log('Raw user data from sessionStorage:', userDataStr);

            if (!userDataStr) {
                throw new Error('No user data found. Please log in again.');
            }

            const userData = JSON.parse(userDataStr);
            console.log('Parsed user data:', userData);

            if (!userData.id && !userData._id) {
                console.log('User missing ID, fetching from backend...');
                const response = await fetch(`/api/users/email/${userData.email}`);
                if (response.ok) {
                    const fullUserData = await response.json();
                    console.log('Fetched full user data from backend:', fullUserData);
                    currentUser = fullUserData;
                    sessionStorage.setItem('user', JSON.stringify(fullUserData));
                } else {
                    throw new Error('Failed to fetch user data from server');
                }
            } else {
                currentUser = userData;
            }

            console.log('User ID check - id:', currentUser.id, '_id:', currentUser._id);

            // Set back button URL based on user role
            setBackButtonUrl(currentUser.role);

            displayUserProfile(currentUser);

            // Handle organizer request button based on role
            const orgButton = document.querySelector('.btn-orange');
            if (orgButton) {
                if (currentUser.role === 4) {
                    // Role 4: Pending request
                    orgButton.disabled = true;
                    orgButton.textContent = 'Request Pending';
                    orgButton.style.opacity = '0.6';
                    orgButton.style.cursor = 'not-allowed';
                    orgButton.onclick = null;
                } else if (currentUser.role === 3) {
                    // Role 3: Approved
                    orgButton.disabled = true;
                    orgButton.textContent = 'Approved';
                    orgButton.style.opacity = '0.6';
                    orgButton.style.cursor = 'not-allowed';
                    orgButton.classList.add('btn-success');
                    orgButton.classList.remove('btn-orange');
                    orgButton.onclick = null;
                } else if (currentUser.role === 1) {
                    // Role 1: Admin - hide the button
                    orgButton.style.display = 'none';
                }
            }

            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

        } catch (error) {
            console.error('Error loading profile:', error);
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = error.message;
        }
    }

    function displayUserProfile(userData) {
        console.log('Displaying user profile for:', userData);

        const avatarContainer = document.getElementById('userAvatar');
        const avatarLetter = document.getElementById('avatarLetter');

        // Display avatar image if available
        if (userData.avatarImage) {
            avatarContainer.innerHTML = `<img src="${userData.avatarImage}" alt="Avatar">`;
        } else {
            avatarContainer.innerHTML = `<span id="avatarLetter">${userData.name ? userData.name.charAt(0).toUpperCase() : 'U'}</span>`;
        }

        document.getElementById('userName').textContent = userData.name || 'User';
        document.getElementById('displayName').textContent = userData.name || '-';
        document.getElementById('displayEmail').textContent = userData.email || '-';

        const roleText = getRoleText(userData.role);
        document.getElementById('userRole').textContent = roleText;
        document.getElementById('displayRole').textContent = roleText;

        let displayId = userData.id;
        if (!displayId && userData._id) {
            if (typeof userData._id === 'object' && userData._id.$oid) {
                displayId = userData._id.$oid;
            } else if (typeof userData._id === 'string') {
                displayId = userData._id;
            }
        }
        console.log('Display ID:', displayId);
        document.getElementById('displayUserId').textContent = displayId || '-';
    }

    function getRoleText(role) {
        switch(role) {
            case 1: return 'Administrator';
            case 2: return 'Customer';
            case 3: return 'Organizer';
            case 4: return 'Pending Organizer Request';
            default: return 'User';
        }
    }

    function setBackButtonUrl(role) {
        const backBtn = document.getElementById('backBtn');

        switch(role) {
            case 1:
                backBtn.href = '/admin-dashboard';
                break;
            case 2:
                backBtn.href = '/customer-dashboard';
                break;
            case 3:
                backBtn.href = '/organizer-dashboard';
                break;
            case 4:
                backBtn.href = '/customer-dashboard'; // Pending organizers see customer dashboard
                break;
            default:
                backBtn.href = '/customer-dashboard';
                break;
        }
    }

    function openAvatarModal() {
        const modal = document.getElementById('avatarModal');
        const preview = document.getElementById('avatarPreview');
        const previewLetter = document.getElementById('previewLetter');
        const removeBtn = document.getElementById('removeAvatarBtn');

        // Show current avatar
        if (currentUser.avatarImage) {
            preview.innerHTML = `<img src="${currentUser.avatarImage}" alt="Avatar">`;
            removeBtn.style.display = 'inline-block';
        } else {
            preview.innerHTML = `<span class="avatar-preview-text" id="previewLetter">${currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U'}</span>`;
            removeBtn.style.display = 'none';
        }

        document.getElementById('fileName').textContent = 'No file chosen';
        selectedAvatarImage = null;
        modal.classList.add('active');
    }

    function closeAvatarModal() {
        document.getElementById('avatarModal').classList.remove('active');
        document.getElementById('avatarFileInput').value = '';
        selectedAvatarImage = null;
    }

    function previewAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Check file size (limit to 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('Image size must be less than 2MB');
            event.target.value = '';
            return;
        }

        // Check file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            event.target.value = '';
            return;
        }

        document.getElementById('fileName').textContent = file.name;

        const reader = new FileReader();
        reader.onload = function(e) {
            selectedAvatarImage = e.target.result;
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = `<img src="${selectedAvatarImage}" alt="Avatar Preview">`;
            document.getElementById('removeAvatarBtn').style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    }

    async function saveAvatar() {
        try {
            const saveBtn = event.target;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            let userId = currentUser.id;
            if (!userId && currentUser._id) {
                if (typeof currentUser._id === 'object' && currentUser._id.$oid) {
                    userId = currentUser._id.$oid;
                } else if (typeof currentUser._id === 'string') {
                    userId = currentUser._id;
                }
            }

            if (!userId) {
                throw new Error('User ID not found. Please log in again.');
            }

            const updateData = {
                name: currentUser.name,
                email: currentUser.email,
                password: currentUser.password,
                role: parseInt(currentUser.role) || 2,
                avatarImage: selectedAvatarImage || currentUser.avatarImage || null
            };

            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                const updatedUser = await response.json();
                currentUser = {
                    ...currentUser,
                    avatarImage: updatedUser.avatarImage
                };
                sessionStorage.setItem('user', JSON.stringify(currentUser));

                displayUserProfile(currentUser);
                closeAvatarModal();

                const successMsg = document.getElementById('updateSuccess');
                successMsg.textContent = 'Avatar updated successfully!';
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);
            } else {
                throw new Error('Failed to update avatar');
            }

        } catch (error) {
            console.error('Error saving avatar:', error);
            alert('Failed to save avatar: ' + error.message);
        } finally {
            const saveBtn = document.querySelector('#avatarModal .btn-primary');
            saveBtn.textContent = 'Save Avatar';
            saveBtn.disabled = false;
        }
    }

    async function removeAvatar() {
        // Show confirmation modal
        showRemoveAvatarModal();
    }

    function showRemoveAvatarModal() {
        document.getElementById('removeAvatarModal').classList.add('active');
    }

    function closeRemoveAvatarModal() {
        document.getElementById('removeAvatarModal').classList.remove('active');
    }

    async function confirmRemoveAvatar() {
        closeRemoveAvatarModal();

        try {
            const removeBtn = document.getElementById('removeAvatarBtn');
            removeBtn.textContent = 'Removing...';
            removeBtn.disabled = true;

            let userId = currentUser.id;
            if (!userId && currentUser._id) {
                if (typeof currentUser._id === 'object' && currentUser._id.$oid) {
                    userId = currentUser._id.$oid;
                } else if (typeof currentUser._id === 'string') {
                    userId = currentUser._id;
                }
            }

            if (!userId) {
                throw new Error('User ID not found. Please log in again.');
            }

            // Update user with null avatar
            const updateData = {
                name: currentUser.name,
                email: currentUser.email,
                password: currentUser.password,
                role: parseInt(currentUser.role) || 2,
                avatarImage: null
            };

            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                const updatedUser = await response.json();

                // Update current user
                currentUser = {
                    ...currentUser,
                    avatarImage: null
                };
                sessionStorage.setItem('user', JSON.stringify(currentUser));

                // Update all UI elements
                displayUserProfile(currentUser);

                // Update modal preview
                selectedAvatarImage = null;
                const preview = document.getElementById('avatarPreview');
                preview.innerHTML = `<span class="avatar-preview-text">${currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U'}</span>`;
                document.getElementById('fileName').textContent = 'No file chosen';
                document.getElementById('avatarFileInput').value = '';

                // Close avatar modal
                closeAvatarModal();

                // Show success message
                const successMsg = document.getElementById('updateSuccess');
                successMsg.textContent = 'Avatar removed successfully!';
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);
            } else {
                throw new Error('Failed to remove avatar');
            }

        } catch (error) {
            console.error('Error removing avatar:', error);
            alert('Failed to remove avatar: ' + error.message);
        } finally {
            const removeBtn = document.getElementById('removeAvatarBtn');
            if (removeBtn) {
                removeBtn.textContent = 'Remove Avatar';
                removeBtn.disabled = false;
            }
        }
    }

    function openEditModal() {
        if (currentUser) {
            document.getElementById('editName').value = currentUser.name || '';
            document.getElementById('editEmail').value = currentUser.email || '';
            document.getElementById('editPassword').value = '';
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('editEmail').style.borderColor = '#e1e1e1';
            document.getElementById('editPassword').style.borderColor = '#e1e1e1';
            document.getElementById('editModal').classList.add('active');
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
        document.getElementById('modalError').style.display = 'none';
        document.getElementById('editEmail').style.borderColor = '#e1e1e1';
        document.getElementById('editPassword').style.borderColor = '#e1e1e1';
    }

    document.getElementById('editForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        document.getElementById('modalError').style.display = 'none';
        document.getElementById('updateSuccess').style.display = 'none';
        document.getElementById('editEmail').style.borderColor = '#e1e1e1';
        document.getElementById('editPassword').style.borderColor = '#e1e1e1';

        const newPassword = document.getElementById('editPassword').value.trim();

        if (newPassword && newPassword.length < 6) {
            document.getElementById('modalError').style.display = 'block';
            document.getElementById('modalErrorText').textContent = 'Password must be at least 6 characters long';
            document.getElementById('editPassword').style.borderColor = '#e74c3c';
            return;
        }

        const updatedData = {
            name: document.getElementById('editName').value.trim(),
            email: document.getElementById('editEmail').value.trim(),
            password: newPassword || currentUser.password,
            role: parseInt(currentUser.role) || 2,
            avatarImage: currentUser.avatarImage || null
        };

        try {
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            let userId = currentUser.id;
            if (!userId && currentUser._id) {
                if (typeof currentUser._id === 'object' && currentUser._id.$oid) {
                    userId = currentUser._id.$oid;
                } else if (typeof currentUser._id === 'string') {
                    userId = currentUser._id;
                }
            }

            console.log('Current user object:', currentUser);
            console.log('Extracted userId:', userId);
            console.log('Update data being sent:', updatedData);

            if (!userId) {
                throw new Error('User ID not found. Please log in again.');
            }

            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData)
            }).catch(err => {
                console.error('Network fetch error:', err);
                throw new Error('NETWORK_ERROR');
            });

            console.log('Response status:', response.status);

            if (response.ok) {
                const updatedUser = await response.json();
                console.log('Updated user from server:', updatedUser);

                currentUser = {
                    ...currentUser,
                    name: updatedData.name,
                    email: updatedData.email
                };

                sessionStorage.setItem('user', JSON.stringify(currentUser));
                displayUserProfile(currentUser);
                closeEditModal();

                const successMsg = document.getElementById('updateSuccess');
                successMsg.textContent = 'Profile updated successfully!';
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);

            } else {
                const errorData = await response.text();
                console.error('Error response:', errorData);

                let errorMessage = 'Email exist';
                try {
                    const errorJson = JSON.parse(errorData);
                    errorMessage = errorJson.message || errorMessage;
                } catch (e) {
                    errorMessage = errorData || errorMessage;
                }

                throw new Error(errorMessage);
            }

        } catch (error) {
            console.error('Error updating profile:', error);
            document.getElementById('modalError').style.display = 'block';
            document.getElementById('modalErrorText').textContent = 'Failed to update profile: ' + error.message;
        } finally {
            const submitBtn = document.querySelector('#editForm button[type="submit"]');
            submitBtn.textContent = 'Save Changes';
            submitBtn.disabled = false;
        }
    });

    // Organizer Request Modal Functions
    function showOrgRequestModal() {
        document.getElementById('orgRequestModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeOrgRequestModal() {
        document.getElementById('orgRequestModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    async function confirmOrgRequest() {
        closeOrgRequestModal();

        try {
            const orgButton = document.querySelector('.btn-orange');
            const originalText = orgButton.textContent;
            orgButton.disabled = true;
            orgButton.textContent = 'Submitting Request...';

            let userId = currentUser.id;
            if (!userId && currentUser._id) {
                if (typeof currentUser._id === 'object' && currentUser._id.$oid) {
                    userId = currentUser._id.$oid;
                } else if (typeof currentUser._id === 'string') {
                    userId = currentUser._id;
                }
            }

            console.log('Submitting organizer request for user:', userId);

            if (!userId) {
                throw new Error('User ID not found. Please log in again.');
            }

            const updatedData = {
                name: currentUser.name,
                email: currentUser.email,
                password: currentUser.password,
                role: 4,
                avatarImage: currentUser.avatarImage || null
            };

            console.log('Sending organizer request with data:', updatedData);

            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedData)
            });

            console.log('Response status:', response.status);

            if (response.ok) {
                const updatedUser = await response.json();
                console.log('Updated user from server:', updatedUser);

                currentUser = {
                    ...currentUser,
                    role: 4
                };

                sessionStorage.setItem('user', JSON.stringify(currentUser));
                displayUserProfile(currentUser);

                // Update back button URL (stays on customer dashboard for pending)
                setBackButtonUrl(4);

                orgButton.textContent = 'Request Pending';
                orgButton.style.opacity = '0.6';
                orgButton.style.cursor = 'not-allowed';
                orgButton.onclick = null;

                const successMsg = document.getElementById('updateSuccess');
                successMsg.textContent = 'Your request has been submitted successfully! You will be notified once it is reviewed.';
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 7000);

            } else {
                const errorData = await response.text();
                console.error('Error response:', errorData);

                let errorMessage = 'Failed to submit request';
                try {
                    const errorJson = JSON.parse(errorData);
                    errorMessage = errorJson.message || errorMessage;
                } catch (e) {
                    errorMessage = errorData || errorMessage;
                }

                throw new Error(errorMessage);
            }

        } catch (error) {
            console.error('Error submitting organizer request:', error);
            alert('Failed to submit request: ' + error.message);

            const orgButton = document.querySelector('.btn-orange');
            orgButton.disabled = false;
            orgButton.textContent = 'Request for Organizer account';
            orgButton.style.opacity = '1';
            orgButton.style.cursor = 'pointer';
        }
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        const editModal = document.getElementById('editModal');
        const avatarModal = document.getElementById('avatarModal');
        const orgModal = document.getElementById('orgRequestModal');
        const removeAvatarModal = document.getElementById('removeAvatarModal');

        if (e.target === editModal) {
            closeEditModal();
        }
        if (e.target === avatarModal) {
            closeAvatarModal();
        }
        if (e.target === orgModal) {
            closeOrgRequestModal();
        }
        if (e.target === removeAvatarModal) {
            closeRemoveAvatarModal();
        }
    });
</script>
</body>
</html>
